This readme is originally posted on Facebook group wall.

長文です。ご覚悟を。
先日RakutenWifiPocketとESP32を利用した罠通知について投稿した者です。

多くの方から嬉しい反響いただきましてありがとうございます。
まずは取り急ぎ、ある程度経験者向けに簡易的な作成方法を投稿します。

なお、下記内容では説明不足で理解できないという方向けにもう少し丁寧な記事（ブログ？）を作成予定です。気長にお待ちください。
ただどちらにしてもarduino/ESPの基礎（何？何ができる？言語は？Lチカ～簡単な制御など）、電子工作基礎（ブレッドボード、ユニバーサル基盤、はんだ、LED、スイッチなど）、電気基礎（オームの法則、キルヒホッフの法則など）などの知識・スキルは必要になります。IoTは日々の生活でも応用の利くとても有効なスキルです。ぜひこの機会に学び始めてみてください。

さて、偉そうに書きましたが、作成者は電子工作歴半年程度の初心者です。
内容について勘違い、間違い、リダンダンシー等ある可能性があります。
コメントで指摘いただけたら幸いです。

前置きは以上です！以下システムの概要です。

■目的・用途
スマホで罠の作動状況を確認できるようにし、見回り作業の軽減化。
sigfoxなどを利用した安価なLPWAサービス（初期コスト7千～1万/台　運用コスト数十～百円/月）も出始めてはいるもののまだ少し高価。
Rakutenモバイルが通信1GB以下0円、WifiPocket本体実質0円のプランを開始（1人1契約1台の縛りあり）。システムの超低価格化（500円～1500円）が可能に。

■全体図について
全体的な回路図は画像(Diagram)の通りです。機器はタッパーなどプラケースに入れて防水してください。

■構成部品
・Rakuten Wifi Pocket（以下RWP）
・ESP32（ピンヘッダ装着済　技適マーク有）
・ピンソケット10P(ESP32の基盤への脱着用） 
・ユニバーサル基盤（10穴×5穴程度にカット）
・フォトカプラ（2.54mm 4ピン DIPマウント PC817）
・47Ω金属皮膜抵抗
・マグネットスイッチ（ノーマルオープン）
・AA×4本バッテリーケース
・AA×4本充電電池（Ni-MH 1.2V） 
・28AWGより線
・防水タッパー（L95 W140 H50程度）
・ブリキ板(10mm×10㎜程度)
・基盤ターミナル2P×2個（ユニバーサル基盤直はんだづけの場合不要）
キャンペーン、廃品、中国系サイトを利用し500円程度で作れました。Amazonだと少し高くなります。
なお、RWPが壊されると修理・2台目は高くつき、このシステムの優位性がほぼ失われます。
雨風、結露、暴れる獲物に壊されないよう、設置場所・方法には注意してください。

■通知フローについて
1.ESP32が起動、フォトカプラに信号を流し、RWPの電源をON
2.罠の作動有無（マグネットスイッチON/OFF）情報をWiFi＞4Gネットワーク＞IFTTTに送付
3.あらかじめ作成しておいたIFTTTのWebhooks→LineNotifyアプレットにより、LineNotifyで罠の作動有無の定期連絡をスマホで受信
4.ESP32は情報送付後RWPの電源を落とし、自身はスリープへ（デフォルトでは1時間）
5.１．に戻る

■動作ロジックについて。
罠の作動＞通知ではなく、（罠の作動の有無情報を乗せた）定時連絡制を採用しています。バッテリー的には不利ですが、システムの正常作動の確認ができます。この方法であっても10日以上は作動しました。

■RWPの基盤へのはんだ配線について
少し難易度の高い作業に、RWPを分解し電源ON/OFFスイッチの±に配線のはんだ付けがあります（画像Wiring）。手作業の限界に近いレベルのサイズです。こて先の細い温度調整機能付きのはんだごて、照明付き拡大鏡等があると良いかと思います。

■RWPのON/OFF制御について
当初はリレーで試作しましたが、リレーの接点作動音が捕獲に影響すると思い、フォトカプラを採用しました。フォトカプラは信号側にLEDを使用しています。データシートを参照して適切な電流を流すための抵抗を入れてください（50Ω～100Ω程度になると思います）。また、フォトカプラの出力側とRWPのON/OFF線は極性があります。逆接続しないようにご注意ください。

■RWPディスプレイについて
電源を入れるとディスプレイがつきます。捕獲に影響すると思いますので接地時は黒ビニテなどで覆い隠してください。

■マグネットスイッチについて
磁力により、ON/OFFするスイッチです。釣り糸などを使って、磁石が風では外れないが獲物がかかれば外れる構造にしてください。プラケースにブリキ板を張り付けて磁石がつくようにしています。マグネットスイッチの構造上、磁力が強すぎる場合等に誤作動領域があります。現物合わせで作動確認してください。

■スケッチについて
「うごけばいいやコード」なので恥ずかしいですがGithubにアップしています（初めて使った）。
https://github.com/granbiel/Trap
Trap.inoとconfig.hで構成しています。config.hの「WiFi SSID」「WiFi Password」「Webhooks Event Name」「Webhooks Key」の4行のみ編集すれば使用できると思います。

■2台目以降の罠について
超近距離であれば磁石の釣り糸を分岐させるだけでも一応対応できます。またRWPのWiFiエリア内であれば、コードに他機の接続用ディレイを設けてあげた上で、RWPを除いた同じ構成（子機）を作成し、罠発動後は親機へ発動情報信号を送り続ける（バッテリーはすぐなくなりますが、1度送ることができればOKなので）ことで対応可能だと思われます（未確認）。

■References
ESP32とは
http://robo.mydns.jp/Lecture/?%C5%C5%BB%D2%B9%A9%BA%EE/ESP32
ESP32でIFTTT→Line通知方法
https://thousandiy.wordpress.com/2017/10/17/esp32_ifttt_line/
https://qiita.com/mascii/items/4c366ad4709469d5fda9


取り急ぎの説明は以上です。作られる方は自己責任でお願いします。
意見、質問、つっこみ、つくれぽコメントくださいー！
